<!DOCTYPE html>
<html>
	<head>
	  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
	  
	  <script type="text/javascript" src="//maps.googleapis.com/maps/api/js?key=AIzaSyDrCXoSYA0GKWtl6I8K2QZDAhe9ryNnQkE&sensor=false"></script>
	  
	  <script type='text/javascript' src='http://code.jquery.com/jquery-1.9.1.js'></script>
	  <script type="text/javascript" src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>

		<script type="text/javascript" src="js/jquery.toastmessage.js"></script>
	<link type="text/css" href="css/jquery.toastmessage.css" rel="stylesheet" />

	  
	  <script type="text/javascript" src="js/jquery.csv-0.71.js"></script>
	  <script type="text/javascript" src="js/oms.min.js"></script>
	  <script type="text/javascript" src="js/jquery.alerts.js"></script>
	  <script type="text/javascript" src="js/jquery.jqGrid.src.js"></script>
	  <script type="text/javascript" src="js/jquery.contextMenu.js"></script>
	  <link rel="stylesheet" href="css/jquery.contextMenu.css" type="text/css" />
	  
	  <script type="text/javascript" src="js/jquery.colorpicker.js"></script>
	  <link rel="stylesheet" href="css/jquery.colorpicker.css" type="text/css" />
	  



	  		<script type="text/javascript" src="js/filereader.js"></script>
		<script type="text/javascript" src="js/uuid.js"></script>
		

	  <script type="text/javascript" src="map.js"></script>
	  
	  <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css">
	 <link rel="stylesheet" href="css/ui.jqgrid.css" type="text/css" />

<script>




//prevent console fail
if (typeof console === "undefined" || typeof console.log === "undefined") {
    console = {};
    console.log = function() {};
}

function getCSV(url, callback) {
	console.log("retrieve: "+url);
    $.ajax({
        url: url,
        cache: false,
        dataType: 'text',
        processData: false,
        type: 'GET',
        success: function(response) {
        	var parsed = $.csv.toObjects(response);
        	if(callback)
        		callback(parsed);
        },
        error: function(request, type, errorThrown) {
        	alert(msg_comm_err);
        }
    });
	
}



function geocodePlaces(places) {
	if(places[0].latitude == undefined) {
		var geocoder = new google.maps.Geocoder();
		var completed = 0;
		
		var deferred = $.Deferred();
		$.each(places, function(idx, place) {
			var locref = place.Address+" "+place.City+" "+place.Province+"  "+place.Pcode;
			setTimeout(function() {
			geocoder.geocode({address: locref}, function(results, status) {
				completed++;
				console.log('geocode: ',locref+" -> ",status);
				if(status == google.maps.GeocoderStatus.OK) {
					console.log("results: ",results);
					console.log("latitude: ",results[0].geometry.location.lat());
					place.coords = {};
					place.coords.latitude = results[0].geometry.location.lat();
					place.coords.longitude = results[0].geometry.location.lng();
				}
				/*
				else {
					console.log("error geocoding: "+locref);
				}
				*/
				console.log(completed+" -> "+places.length);
				if(completed == places.length)
					deferred.resolve(places);
			});
			}, idx*2000);
		});
		
		return deferred.promise();
		
	}
	
	return "";
	
}

function createLink(from, to, open) {
	var f = indexedPlaces[from];
	var t = indexedPlaces[to];

	var type = Object.keys(indexedLinkTypes)[0];
	
	var link = {start: f.id, end: t.id, type: type};
	links.push(link);
	
	var line = map.drawLink(link, f, t, indexedLinkTypes[type]);
	if(open)
		google.maps.event.trigger(line, 'click');
}

function createCSV(data) {
	var str ='';
	//quick & dirty create all values as quoted
	$.each(data, function(idx, itm) {
		var first = true;
		$.each(itm, function(key, value) {
			(first)? first=false : str+=",";
			
			str += '"'+value+'"';
		})
		str+="\n";
	});

	return str;
}

function outputTable() {
	var model = $("#placeTable").jqGrid('getGridParam', 'colModel');
	var data = $("#placeTable")[0].p.data.slice(0);

	//remove internals 
	$.each(data, function(idx, itm) {
		delete itm.links;
		delete itm.marker;
	});
	
	var placecsv = createCSV(data);
	var linkcsv = createCSV(links);
	
 	var full = {
 			placeList: data,
 			linkList: links,
 			linkTypes: indexedLinkTypes,
 			mapStyle: map.style
 	};
 	console.log("full:",full);
 	
 	var jsonoutput = JSON.stringify(full, null, 2);
 	
 	$("#placeCSV").val(placecsv);
 	$("#linkCSV").val(linkcsv);
 	$("#jsonoutput").val(jsonoutput);
 	
 	$("#placecsvdownload").attr("href", "data:text/csv;charset=utf-8,"+escape(placecsv));
 	$("#linkcsvdownload").attr("href", "data:text/csv;charset=utf-8,"+escape(linkcsv));

 	$("#jsondownload").attr("href", "data:text/csv;charset=utf-8,"+escape(jsonoutput));
 	
	$("#outputtabs").dialog("open");
}


function loadPlaces(places) {
	indexedPlaces={};

	$.each(places, function(idx, place) {
		//place.name = place['Institutions - Eng Name'];
	
		if(place.geom.coordinates[0]) {
			place.marker = map.drawPlace(place, createLink, handleSelectPlace, handleDrag, handleDragEnd);
		}
		
		if(place.organizationType) {
			place.organizationType.toString = function() {
				return this.type;
			}
		}
		
		indexedPlaces[place.uuid] = place;
	});
}

function getFirstProperty(obj) {
	return obj[Object.keys(obj)[0]];
}

function handleDrag(place) {
	//$("#placeTable").jqGrid('setCell', place.uuid, 'latitude', place.latitude);
	//$("#placeTable").jqGrid('setCell', place.uuid, 'longitude', place.longitude);
}

function handleDragEnd(place) {
	console.log("location update, merge it:",place);
	mergeOrganization(place);
}


function handleSelectPlace(id) {
	$("#placeTable").jqGrid('setSelection', id);	
}

function showLinks() {
	map.clearLines();
	
	$.each(links, function(idx, link) {
		var from = indexedPlaces[link.start];
		var to = indexedPlaces[link.end];
		console.log("call draw link...");
		var line = map.drawLink(link, from, to, indexedLinkTypes[link.type]);
	});
}

function doresize() {
	var h = $(window).height();
	
	if($("#bottom").is(":visible")) {
		var bottomh = $("#bottom").height();
		var toolbarh = $("#toolbar").height();
		h = $(window).height()-bottomh;

		$("#placeTable").setGridWidth($(window).width());
		$("#placeTable").setGridHeight(bottomh-toolbarh);
	}
	$("#map_canvas").height(h);
	$("#map3d").height(h);
}

$(document).ready(function() {
	editMode = false;
	
	
	if(querystring("mode") == "editMode")
		editMode = true;
	
	
	console.log("editmode: ", editMode);
	var locations;
	
	//hardcoded links for now.
	
	indexedLinkTypes = {} 

	
	$("#orgTypeDialog").dialog({
		autoOpen: false,
		title: 'Manage Organization Types',
		width: 400,
		height: 400,
		buttons: {'Done': function() {
				$(this).dialog("close");
			}
		}
	});
	setupOrgTypes();
	
	
	$("#fileinput").hide().fileReaderJS({
			on: {
				load: function(e, file) {
					console.log("****************************** FILE: ", file);
					console.log("e:",e);
					
                    var fileReader = new FileReader();
                    fileReader.onloadend = function(e) {
						try {
							showData(JSON.parse(this.result));
	                    } catch(e) {
	        				alert("Unable to parse file: "+e);
	        			}
                    };
                    console.log("call readAs Text...");
                    fileReader.readAsText(file);
				},
				error: function(e, file) {
	            },
				groupstart: function(group) {
				},
				groupend: function(group) {
				}
			}
	});

	//setup map
	map = new Map();

	
	$(document).keyup(function(e) {
		//pass escape thru to allow map to stop edit operations
		  if (e.keyCode == 27) { 
			  map.notifyEscape();
		  }
	});	

	
		
			//links = [{start: 0, end: 37, type:'10G'},
	//	         {start: 0, end: 5, type:'A'}];
		
		//resize components with window/split pane change
		$(window).bind('resize', function() {
			doresize();
		}).trigger('resize');
		
		$("#bottom").resizable({
			handles: "n"		
		}).resize(function(event) {
			doresize();	
			return false;
		});
		
		//toolbar
		
		$.contextMenu({
			selector: "#settingsButton",
			trigger: 'left',
			build: function($trigger, e) {
				return {
					callback: function(key, options) {
						if(key == 'orgTypes') {
							$("#orgTypeDialog").dialog("open");
						}
					},
					
					items: {'orgTypes': {name:'Organization Types'},
							'networks': {name:'Networks'}
					}
				};
			}
		});
		
		$("#openButton").click(function() {
			$("#fileinput").click();
			return false;
		});

		
 		$("#exportButton").click(function() {
 			outputTable();
 		});

 		$("#linkTypeButton").click(function() {
 			$("#linkTypes").html(JSON.stringify(indexedLinkTypes, null, 2));
 	 		$("#linkTypeDialog").dialog("open");
 		});
 		
 		$("#mapStyleButton").click(function() {
 			$("#mapstyle").html(JSON.stringify(map.mapStyles, null, 2));
 	 		$("#mapStyleDialog").dialog("open");
 		});
 		
 		$("#mapStyleDialog").dialog({
 			autoOpen: false,
 			modal: true,
 			width: 600,
 			 buttons: {
 		        "Update Style": function() {
 		        	try {
 						var style = JSON.parse($("#mapstyle").val());
 						console.log(style);
 						map.map.setOptions({styles: style});
 					} catch(e) {
 						alert("Unable to update style: JSON failed to parse");
 					}
 				    $( this ).dialog( "close" );
 		        },
 		        Cancel: function() {
 		          $( this ).dialog( "close" );
 		        }
 		      }
 		});
 		$("#linkTypeDialog").dialog({
 			autoOpen: false,
 			modal: true,
 			width: 600,
 			 buttons: {
 		        "Update": function() {
 		        	try {
 						indexedLinkTypes = JSON.parse($("#linkTypes").val());
 						showLinks();
 					} catch(e) {
 						alert("Unable to update link types: JSON failed to parse");
 					}
 				    $( this ).dialog( "close" );
 		        },
 		        Cancel: function() {
 		          $( this ).dialog( "close" );
 		        }
 		      }
 		});
 		
 		
		$("#addButton").click(function() {
			addRow();
		});
		$("#deleteButton").click(function() {
			var row = $("#placeTable").jqGrid("getGridParam", "selrow");
			console.log("row: ",row);
			deleteRow(row);
		});
		
		//setup export dialog
		$("#placecsvdownload").button();
		$("#linkcsvdownload").button();
		$("#jsondownload").button();
	 	
		$("#outputtabs textarea").focus(function () {
			this.select();
	        this.onmouseup = function() {
	            this.onmouseup = null;
	            return false;
	        };
		});
	 	var tabs = $("#outputtabs").tabs();
	
		tabs.dialog({
			width: 'auto',
			autoOpen: false

		});
	
		
		//TODO: will work below into file open
		/*
		//used to parse and geocode the locations from a csv
		getCSV("institutions.csv", function(places) {
			var geocodePlacesComplete = geocodePlaces(places);
	
			console.log("got promise:",geocodePlacesComplete);
			
			$.when(geocodePlacesComplete).then(function(results) {
				console.log("geocoding complete...");
				console.log(results);
				console.log(JSON.stringify(results));
				
				loadPlaces(results);
			});
	
		});
		*/
	
	if(!editMode) {
		$("#bottom").hide();
		doresize();
	}

		
	$.getJSON('ns/organization', function(result) {
		console.log(result);
		places = result;
		loadPlaces(result);
		setupTable();

	});

		
		
})

function colorFormatter(cellvalue, options, rowObject) {
	return "<span style='display: inline-block; width:20px; height:20px; background-color: "+cellvalue+"'/>";
}

function hexc(colorval) {
    var parts = colorval.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
    delete(parts[0]);
    for (var i = 1; i <= 3; ++i) {
        parts[i] = parseInt(parts[i]).toString(16);
        if (parts[i].length == 1) parts[i] = '0' + parts[i];
    }
    color = '#' + parts.join('');
}

function setupOrgTypes() {
	$.getJSON("ns/organization/types", function(types) {
	organizationTypes = types;
	
	orgTypesById = {};
	orgTypesByType = {};
	$.each(organizationTypes, function(idx, itm) {
		orgTypesById[itm.uuid] = itm;
		orgTypesByType[itm.type] = itm;
	});
	
	var colNames = ["UUID","Organization Type", "Colour"];
	var colModel = [
     {
     	hidden: true,
     	name: 'uuid',
     	key: true
     },
	                {
		editable: true, 
		name: 'type', 
		sortable: true
	},
	{
		editable: true, 
		name: 'colour', 
		sortable: true,
		formatter: colorFormatter,
		edittype: 'custom',
		editoptions: {
			custom_element: function(value, options) {
				console.log(value, options);
				var $span = $(value);
				
				var input = $("<input>", {type: 'input', value: $span.css("background-color")}).colorpicker({
					colorFormat: "RGB"
				});
				return input[0];
				
			},
			custom_value: function(elem) {
			 	var val = $(elem).val();
			 	console.log("val: ", val);
			 	return val;
			}
		}
	}
	];
	
	var orgTypeLastSel;
	var tableOptions = {
			datatype: "local",
			sortable: true,
			colNames:colNames,
			colModel:colModel,
			shrinkToFit: true,
			height: 175,
			width: 400,
			rowNum: types.length,
		   	rowList:[10,20,30],
		   	scroll: true,
		   	scrollrows: true,
//		   	pager: '#pagernav',
			onSelectRow: function(id, status, event){
				//check if edit bailed
				if(id && id!==orgTypeLastSel){
					$("#orgTypeTable").jqGrid('restoreRow',orgTypeLastSel);
				}
			},
			ondblClickRow: function (id, ri, ci, e) {
				//edit on double click

				orgTypeLastSel=id;
				
				$("#orgTypeTable").jqGrid('editRow', id, {
			    	url: 'clientArray',
			    	keys: true,
			    	aftersavefunc: function() {
			    		console.log("id:",id);
			    		mergeOrgType(orgTypesById[id]);
			    	}
			    });    
				
				
				
			}
			
		};
	
	
		var table = $("#orgTypeTable").jqGrid(tableOptions).navGrid("#pagernav",{edit:false,add:false,del:false});
		table[0].p.data = types;
		table.trigger('reloadGrid');

		
		$("#orgTypeAddButton").click(function() {
			mergeOrgType({colour:"black"}, function(org) {
				var table = $("#orgTypeTable").jqGrid('addRowData', org.uuid, org, "first");
				$("#orgTypeTable").jqGrid('editRow', orig.uuid, true, 'clientArray');
			});
		});
		
		
		$("#orgTypeDeleteButton").click(function() {
			var id = $("#orgTypeTable").jqGrid("getGridParam", "selrow");
			$.confirm("Do you want to delete "+orgTypesById[id].type+"?", {
				title: 'Confirm Delete',
				buttons: {
					"Yes": function() {
						deleteOrgType(id);
						$(this).dialog("close");

						$("#orgTypeTable").jqGrid('delRowData', id);
					},
					"No": function() {
						$(this).dialog("close");
					}
				}
			});
		});

		
	});
}

function deleteCall(url, callback) {
	$.ajax({
        url: url,
        cache: false,
		headers: {
		    'Accept' : 'application/json',
		    'Content-Type' : 'application/json'
			},
        processData: false,
        type: 'DELETE',
        success: function(response) {
        	console.log(response);
        	if(callback)
        		callback(response);
        },
        error: function(request, type, errorThrown) {
        	console.log("in error...");
        	handleError(request);
        }
    });
	
}

function deleteOrganization(id, callback) {
	deleteCall("ns/organization/"+id, callback);	
}

function deleteOrgType(id, callback) {
	deleteCall("ns/organization/type/"+id, callback);	
}

function mergeOrgType(orgType, callback) {
	console.log("orgType:",orgType);
	
	$.ajax({
        url: 'ns/organization/type',
        dataType: 'json', 
        data: JSON.stringify(orgType),
        cache: false,
		headers: {
		    'Accept' : 'application/json',
		    'Content-Type' : 'application/json'
			},
        processData: false,
        type: 'POST',
        success: function(response) {
        	console.log(response);
        	if(callback)
        		callback(response);
        },
        error: function(request, type, errorThrown) {
        	handleError(request);
        }
    });
}


function mergeOrganization(org, callback) {
	var record = $.extend({},org);
	
	delete record.marker;
	delete record.links;
	delete record.latitude;
	delete record.longitude;

	
	
	$.ajax({
        url: 'ns/organization',
        dataType: 'json', 
        data: JSON.stringify(record),
        cache: false,
		headers: {
		    'Accept' : 'application/json',
		    'Content-Type' : 'application/json'
			},
        processData: false,
        type: 'POST',
        success: function(response) {
        	console.log(response);
        	if(callback)
        		callback(response);
        },
        error: function(request, type, errorThrown) {
        	handleError(request);
        }
    });
	
}
function showToast(msg, sticky, type) {
	if(type == undefined)
		type='notice';
	
    $().toastmessage('showToast', {
        text     : msg,
        position: 'middle-center',
        sticky   : sticky,
        type     : type
    });
}

function handleError(request) {
	showToast(getError(request), false, 'error');
}

function getError(request) {
	var message = "Error Occurred!";
	
	if (request.status) message += '  Error Code: [' + request.status + ']';
	if (request.statusText) message += '  Error Message: [' + request.statusText + ']';
	
	if (request.responseText) {
		var text = request.responseText;
		try {
			text = JSON.parse(request.responseText).message;
		} catch(e) {}
		if (text && text.length > 0) {
			message += '  Response Text: ' + text;
		}
	}

	return message;
}

function showData(results) {
	map.clearOverlays();
	
	console.log(results);
	indexedLinkTypes = results.linkTypes;

	map.setStyle(results.mapStyle)
	
	links = results.linkList;
	loadPlaces(results.placeList);
	places = results.placeList;
	showLinks();
	setupTable();
}

function querystring(key) {
   var re=new RegExp('(?:\\?|&)'+key+'=(.*?)(?=&|$)','gi');
   var r=[], m;
   while ((m=re.exec(document.location.search)) != null) r.push(m[1]);
   return r;
}

var myfunc = function() {
	console.log('here');
}

function setupTable() {
	if(!editMode)
		return;
	
	var placeObj = getFirstProperty(indexedPlaces);

	var colNames = [];
	var colModel = [];

	//setup table model based on properties of object
	$.each(placeObj, function(key, val) {
		console.log("key:",key,"val:",val);
		
		//Internal types we don't want in the table
		if(key == 'marker' || key == 'links')
			return true;
		
		var name = key;
		console.log('name:',name);
		colNames.push(key);
		
		var opts = {
				name: name,
				editable: true,
				sortable: true,
				sorttype: 'text'
			};

		if(key == "uuid") {
			opts.key = true;
			opts.hidden = true;		
		}
		
		if(key == 'organizationType') {
			opts.edittype = 'custom';
			opts.editoptions = {
				custom_element: function(value, options) {
					console.log(value, options);

					var select = $("<select>");
					
					$.each(organizationTypes, function(idx, itm) {
						var option = $("<option>", {value: itm.type}).html(itm.type).appendTo(select);
						if(itm.type == value)
							option.attr("selected", "selected");
						
					});
					
					return select;
				},
				custom_value: function(elem) {
				 	var val = $(elem).val();
				 	console.log("val: ", val);
				 	return val;
				}
			};
		}
		else if(key == 'connected') {
			opts.edittype = 'checkbox';
			opts.editoptions = {
				value: "true:false"
			};
		}
		else if(key == 'geom') {
			opts.hidden = true;
		}
		
		
		
		colModel.push(opts);
	});
	
	
	var w = $(window).width();
	var lastsel;
	
	console.log("colNames:",colNames);
	console.log("colModel:",colModel);
	
	tableOptions = {
			datatype: "local",
			sortable: true,
			colNames:colNames,
			colModel:colModel,
			shrinkToFit: true,
			height: 175,
			width: w,
			rowNum:places.length,
		   	rowList:[10,20,30],
		   	scroll: true,
		   	scrollrows: true,
//		   	pager: '#pagernav',
			onSelectRow: function(id, status, event){
				//check if edit bailed
				if(id && id!==lastsel){
					$("#placeTable").jqGrid('restoreRow',lastsel);
				}
				
				//show corresponding infowindow on map
				if(event) {
					//only call if user actually click (otherwise recursive loop)
					if(indexedPlaces[id].marker) {
						map.zoomTo(indexedPlaces[id].marker);
					}
				}
				
			},
			ondblClickRow: function (id, ri, ci, e) {
				//edit on double click

				lastsel=id;
	//		    $("#placeTable").jqGrid('editRow', id, true, 'clientArray');
				editRow(id);
			    
			}
			
		};
	
	
	var table = $("#placeTable").jqGrid(tableOptions).navGrid("#pagernav",{edit:false,add:false,del:false});
	
	//set data reference directly on table so that we are linked for updates
	table[0].p.data = places;
	table.trigger('reloadGrid');
	
	$.contextMenu({
		selector: ".ui-jqgrid tr",
		build: function($trigger, e) {
			console.log(e);
			
			console.log('^^^^^^^^^^^^^^^^^^^^^^^^^ target:',$(e.target));
			
	     	//var id = $(e.target).parent('th').attr('id');
			var id = $trigger.attr('id');
			
			var items = {'edit': {name : "Edit"}};
			var sel = $("#placeTable").jqGrid("getGridParam", "selrow");

			var address = indexedPlaces[sel].postalCode; 
			if(address) {
				items['geocode'] = {name: "Geocode Postal Code."};
			}
			
			
			return {
				callback: function(key, options) {
					if(key == "edit")
						editRow(sel);
					else if(key == "geocode") {
						var geocoder = new google.maps.Geocoder();
						
						geocoder.geocode({address: address}, function(results, status) {
							console.log('geocode: ',address+" -> ",status);
							if(status == google.maps.GeocoderStatus.OK) {

								var newLatLng = new google.maps.LatLng(results[0].geometry.location.lat(), results[0].geometry.location.lng());
								indexedPlaces[sel].marker.setPosition(newLatLng);
								indexedPlaces[sel].geom = {type: "Point", coordinates: [newLatLng.lng(), newLatLng.lat()]};

								mergeOrganization(indexedPlaces[sel]);
//								console.log("save here too...");

							} else {
								showToast("unable to geocode", false, 'error');
							}
							
						});
						
					}
						console.log("geocode" + address);
				},
				items: items	
			};
		}
	});
	
}


function deleteRow(id) {
	$.confirm("Do you want to delete "+indexedPlaces[id].name+"?", {
		title: 'Confirm Delete',
		buttons: {
			"Yes": function() {
				deleteOrganization(id);
				
				
				$(this).dialog("close");
				map.removeMarker(indexedPlaces[id].marker);
				$("#placeTable").jqGrid('delRowData', id);
				delete indexedPlaces[id];
			},
			"No": function() {
				$(this).dialog("close");
			}
		}
	});
}

function editRow(id) {
	$("#placeTable").jqGrid('editRow', id, {
    	url: 'clientArray',
    	keys: true,
    	aftersavefunc: function() {
    		//update back to objects
			var pos = indexedPlaces[id].marker.getPosition();
			indexedPlaces[id].geom = {type: "Point", coordinates: [pos.lng(), pos.lat()]};
			indexedPlaces[id].organizationType = orgTypesByType[indexedPlaces[id].organizationType];
			
			mergeOrganization(indexedPlaces[id]);
    	}
    });
}

function addRow() {
	var center = map.map.getCenter();
	
	mergeOrganization({
		geom: {type: 'Point', coordinates: [center.lng(), center.lat()]}
	}, function(place) {
		var table = $("#placeTable").jqGrid('addRowData', place.uuid, place, "first");

		
		mergeOrganization(place);
		
		//keep index up to date, note jqgrid does an extend, so we need to get the reference from our linked array.
		place = places[places.length-1];
		indexedPlaces[id] = place;
		
		place.marker = map.drawPlace(place, createLink, handleSelectPlace, handleDrag, handleDragEnd, true);

	    $("#placeTable").jqGrid('editRow', id, true, 'clientArray');
	});
	
}

function getAutocomplete(value, options) {
	console.log("in get autocomplete...", types);
	  var e = $("<input>");
	  e.autocomplete({
		  source: types
	  });
	  e.val(value);
	  return e;
}


function setValue(elem, operation, value) {
    if(operation === 'get') {
       return $(elem).val();
    } else if(operation === 'set') {
       $(elem).val(value);
    }
}


</script>


<style>

body, html {
height:100%;
width:100%;
margin:0px;
padding:0px;
}

.btn {
padding-top:2px;
padding-right:5px;
cursor: pointer;
}

.ui-button .ui-icon.draw-icon {
    background-image: url('images/draw.png') !important;
    width: 26px;
    height: 26px; 
    top: 14px;
}

.ui-button-text-icon-primary .ui-button-text {
    padding: 0.4em 1em .4em 2.3em;
}

</style>
</head>
  
<body>
	<div id="map_canvas" style="width:100%; height:100px;"></div>
	<div id="bottom" style="border-top: 3px solid lightgrey; position: absolute; left:0px; bottom:0px; width:100%; height:225px;'">
	
		<div id="toolbar" style="margin-left:10px; height:25px; width:100%">
			<img title="Settings" id="settingsButton" class="btn" style="float:right; margin-right:20px;"src='images/settings.png'>
			<img title="Open Map" id="openButton" class="btn" src='images/open.png'>
			<img title="Add Place" id="addButton" class="btn" src='images/add.png'>
			<img title="Delete Place" id="deleteButton" class="btn" src='images/delete.png'>
			<img title="Save" id="exportButton" class="btn" src='images/save.png'>
			<img title="Edit Link Types" id="linkTypeButton" class="btn" src='images/links.png'>
			<img title="Edit Map Styles" id="mapStyleButton" class="btn" src='images/map.png'>
			<input id="fileinput" type="file"/>
		</div>
		<table id="placeTable"></table>
	 </div>
	 
	 <div id="outputtabs">
	 	<ul>
			<li><a href="#jsontab">JSON</a></li>
			<li><a href="#csvtab">CSV</a></li>
	 	</ul>
	 	<div id="csvtab">
	 		<div>Places</div>
	 		<textarea id="placeCSV" style="width:600px; height:300px;"></textarea>
	 		<div>Links</div>
	 		<textarea id="linkCSV" style="width:600px; height:300px;"></textarea>
	 		<br/>
	 		<a id="placecsvdownload" download="place.csv">Download place.csv</a>
	 		<a id="linkcsvdownload" download="link.csv">Download link.csv</a>
		 	</div>
	 	<div id="jsontab">
	 		<textarea id="jsonoutput" style="width:600px; height:600px;"></textarea>
	 		<br/>
	 		<a id="jsondownload" download="netmap.json">Save</a>
	 	</div>
	 </div>
	 
	 <div id="mapStyleDialog" title="Edit Map Style">
	 	<textarea id="mapstyle" style="width:500px; height: 500px;"></textarea>
	 	<div>Build custom map styles at <a target="_new" href="http://gmaps-samples-v3.googlecode.com/svn/trunk/styledmaps/wizard/index.html">http://gmaps-samples-v3.googlecode.com/svn/trunk/styledmaps/wizard/index.html</a></div>
	 </div>
	 
	  <div id="linkTypeDialog" title="Edit Link Types">
	 	<textarea id="linkTypes" style="width:500px; height: 500px;"></textarea>
	 </div>
	 
	 	 
<!-- 
	<div style="padding-left:20px; width:600px; overflow:hidden;">
		Styles:<br/>
		<textarea style="width:500px; height:500px;" id="mapstyle"></textarea>
		<br/>
		<br/>
		
		
		<p>
		Links:<br/>
		<div id="links"></div>
	</div>
 -->	 	
	
	<div id="orgTypeDialog">
		<div id="orgTypeToolbar" style="margin-left:10px; height:25px; width:100%">
			<img title="Add" id="orgTypeAddButton" class="btn" src='images/add.png'>
			<img title="Edit" id="orgTypeEditButton" class="btn" src='images/edit.png'>
			<img title="Delete" id="orgTypeDeleteButton" class="btn" src='images/delete.png'>
		</div>
		<table id="orgTypeTable"></table>
	</div>
	
	
</body>

</html>
  