<!DOCTYPE html>
<html>
	
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		 
		<script type="text/javascript" src="//maps.googleapis.com/maps/api/js?key=AIzaSyDrCXoSYA0GKWtl6I8K2QZDAhe9ryNnQkE&sensor=false"></script>
		 
		<script type='text/javascript' src='http://code.jquery.com/jquery-1.9.1.js'></script>
		<script type="text/javascript" src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
		
		<script type="text/javascript" src="js/jquery.ui.touch-punch.js"></script>
		
		<script type="text/javascript" src="js/jquery.toastmessage.js"></script>
		<link type="text/css" href="css/jquery.toastmessage.css" rel="stylesheet" />
		
		<script type="text/javascript" src="js/jquery.csv-0.71.js"></script>
		<script type="text/javascript" src="js/oms.min.js"></script>
		<script type="text/javascript" src="js/jquery.alerts.js"></script>
		<script type="text/javascript" src="js/jquery.jqGrid.src.js"></script>
		<script type="text/javascript" src="js/jquery.contextMenu.js"></script>
		<script type="text/javascript" src="netmap.editPopup.js"></script>
		
		<link rel="stylesheet" href="css/jquery.contextMenu.css" type="text/css" />
		 
		<script type="text/javascript" src="js/jquery.colorpicker.js"></script>
		<link rel="stylesheet" href="css/jquery.colorpicker.css" type="text/css" />
		
		<script type="text/javascript" src="js/filereader.js"></script>
		<script type="text/javascript" src="js/uuid.js"></script>
		
		
		<script type="text/javascript" src="map.js"></script>
		<script type="text/javascript" src="netmap.js"></script>
		 
		<link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css">
		<link rel="stylesheet" href="css/ui.jqgrid.css" type="text/css" />
		
		<link rel="stylesheet" href="netmap.css" type="text/css" />



<script>

//prevent console fail
if (typeof console === "undefined" || typeof console.log === "undefined") {
    console = {};
    console.log = function() {};
}

function showLinks() {
	map.clearLines();
	
	$.each(links, function(idx, link) {
		var from = indexedPlaces[link.orgStartUUID];
		var to = indexedPlaces[link.orgEndUUID];
		var line = map.drawLink(link, from, to, indexedLinkTypes[link.type]);
	});
}

function doresize() {
	var h = $(window).height();
	
	if($("#bottom").is(":visible")) {
		var bottomh = $("#bottom").height();
		var toolbarh = $("#toolbar").height();
		h = $(window).height()-bottomh;

		$("#placeTable").setGridWidth($(window).width());
		$("#placeTable").setGridHeight(bottomh-toolbarh);
	}
	$("#map_canvas").height(h);
	$("#map3d").height(h);
}

var indexedLinkTypes;
var networks;
var indexedPlaces;
var locations;
var map;

$(document).ready(function() {

	$("#searchText").change(function() {
		var geocoder = new google.maps.Geocoder();

		geocoder.geocode({
			address : $(this).val()
		}, function(results, status) {
			console.log('geocode: ', " -> ", status);
			if (status == google.maps.GeocoderStatus.OK) {
				map.map.setCenter(results[0].geometry.location);
		        if (results[0].geometry.viewport) 
		          map.map.fitBounds(results[0].geometry.viewport);
			} else {
				showToast("unable to geocode", false, 'error');
			}

		});
	});
	
	editMode = false;
	
	if(querystring("mode") == "editMode") {
		editMode = true;
	}
	
	//setup map
	map = new Map();

	$(document).keyup(function(e) {
		//pass escape thru to allow map to stop edit operations
		  if (e.keyCode == 27) { 
			  map.notifyEscape();
		  }
	});	

	//resize components with window/split pane change
	$(window).bind('resize', function() {
		doresize();
	}).trigger('resize');
	
	if(!editMode) {
		
		$.getJSON('ns/organization/displayDetails', function(result) {
			orgDisplayItems = $.map(result, function(itm, idx) {
				if(itm.visible)
					return itm.name;
			});			
		});
		
	}
		
	var promises = [];	

	promises.push($.getJSON('ns/networkConnection/speeds'));
	promises.push($.getJSON('ns/networkConnection/networks'));
	promises.push($.getJSON('ns/organization/types'));
	promises.push($.getJSON('ns/organization'));
	promises.push($.getJSON('ns/networkConnection'));

	$.when.apply($, promises).done(function() {
		console.log('Netmap Init Promises: ', arguments);
		
		indexedLinkTypes = arguments[0][0];
		networks = arguments[1][0];
		organizationTypes = arguments[2][0];
		places = arguments[3][0];
		links = arguments[4][0];
		
		indexedPlaces={};
		$.each(places, function(idx, place) {
			indexedPlaces[place.uuid] = place;
			if(place.organizationType) {
				place.organizationType.toString = function() {
					return this.type;
				};
			}
		});
		
		if(editMode) {
			$("#edit_canvas").load("edit.html", function() {
				loadPlaces(places);
				showLinks();
				createMapController();
			});
		} else {
			loadPlaces(places);
			showLinks();
			createMapController();			
		}

	});
	
})

function createMapController() {
	var me = this;
	
	$.each(organizationTypes, function(index, type) {
		var checkbox = $('<input>').attr({ type: 'checkbox', id: type.uuid, checked: true});
		var style = 'color: ' + type.colour + ';';
		$("#mapOrgTypes").append($('<div>', {style: 'margin:3px;'})).append($('<label>', {style : style}).html(type.type).prepend(checkbox));
		
		checkbox.change(function() {
			var selected = this.checked;
			var id = $(this).attr('id');
			me.map.markerVisibility(selected, id);
		});
	})

	
	$.each(networks, function(index, network) {
		var checkbox = $('<input>').attr({ type: 'checkbox', id: network.uuid, checked: true});
		var style = 'color: ' + network.colour + ';';
		$("#mapNetworks").append($('<div>', {style: 'margin:3px;'})).append($('<label>', {style: style}).html(network.name).prepend(checkbox));

		checkbox.change(function() {
			var selected = this.checked;
			var id = $(this).attr('id');
			me.map.lineVisibility(selected, id);
		});
	})
	
	$("#mapController").draggable();
	
	$("#mapStyleSelect").change(function() {
		var select = $(this);
		var style = JSON.parse(select.find('[value="'+select.val()+'"]').data("mapstyle"));
		map.map.setOptions({styles: style});
		
	});
	
	$("#chooseMapStyleButton").button().click(function() {
		$.getJSON("ns/mapStyles", function(result) {
	
			var select = $("#mapStyleSelect");
			select.empty();
			$.each(result, function(idx, itm) {
				var op = $("<option>", {value:itm.name}).html(itm.name).appendTo(select);
				op.data("mapstyle", itm.style);
			});
			
			$("#mapStyleChooser").dialog("open");
		});
		
	});
}

function loadPlaces(places) {

	$.each(places, function(idx, place) {
	
		if(place.geom.coordinates[0]) {
			if (editMode)
				place.marker = map.drawPlace(place, createLink, handleSelectPlace, handleDrag, handleDragEnd);
			else
				place.marker = map.drawPlace(place);
		}
		
		if(place.organizationType) {
			place.organizationType.toString = function() {
				return this.type;
			};
		}
	});
}

function showOrgDetails() {

	$.getJSON('ns/organization/displayDetails', function(result) {
		var div = $("<div>");

		var ul = $("<ul>", {id: 'displayDetails'}).appendTo(div);
		
		$.each(result, function(idx, itm) {
			var li = $("<li>", {'data-value': itm.uuid, 'class': 'ui-state-default'}).html(itm.name)
			.appendTo(ul)
			.append($("<span>", {'class': 'ui-icon ui-icon-grip-dotted-horizontal', style: 'float: right; display: inline-block'}));
			
			if(!itm.visible)
				li.addClass("ui-state-disabled");
			
			li.click(function() {
				   if($(this).hasClass('ui-state-disabled'))
					   $(this).removeClass("ui-state-disabled");
				   else
					   $(this).addClass("ui-state-disabled");
				});
			
		});
		
		ul.sortable({
	      placeholder: "ui-state-highlight"
	    });
		
		
		div.dialog({
			title: "User Org Details",
			width: 'auto',
			height: 'auto',
			buttons: { 'Okay': function() {
				var newDetails = $.map($("#displayDetails li"), function(itm, idx) { 
					var $itm = $(itm);
					var obj = { 
						visible: !$itm.hasClass("ui-state-disabled"),
						uuid: $itm.attr("data-value"),
						name: $itm.text(),
						sortOrder: idx
					}
					return obj;
				});
				
				
				post('ns/organization/displayDetails', newDetails);
				$(this).dialog("close");
			},
			'Cancel': function() {
				$(this).dialog("close");
			}
			},
			close: function(event, ui) {
				$(this).dialog('destroy').remove();
			}
		});
	});
	
	
}

function querystring(key) {
   var re=new RegExp('(?:\\?|&)'+key+'=(.*?)(?=&|$)','gi');
   var r=[], m;
   while ((m=re.exec(document.location.search)) != null) r.push(m[1]);
   return r;
}


function getAutocomplete(value, options) {
	console.log("in get autocomplete...", types);
	  var e = $("<input>");
	  e.autocomplete({
		  source: types
	  });
	  e.val(value);
	  return e;
}


function setValue(elem, operation, value) {
    if(operation === 'get') {
       return $(elem).val();
    } else if(operation === 'set') {
       $(elem).val(value);
    }
}


</script>


</head>
  
	<body>
		<div id="map_canvas" style="width:100%; height:100px;"></div>
		<div id="edit_canvas"></div>

		<div id="mapController" class="mapController">
			<input id="searchText" placeholder="Search Location"></input>
			
			<div style="padding:5px;">
				<strong>Organization Types</strong>
				<div id="mapOrgTypes"></div>
			</div>
					
			<div style="padding:5px; padding-top: 10px;">
				<strong>Networks</strong>
				<div id="mapNetworks"></div>
			</div>
			
			<button id="chooseMapStyleButton">Map Style</button>
		</div>
	</body>

</html>
  
